!function(e){class r{constructor(){this._eventHandlers={}}isValidType(e){return"string"==typeof e}isValidHandler(e){return"function"==typeof e}on(e,r){if(!e||!r)return!1;if(!this.isValidType(e))return!1;if(!this.isValidHandler(r))return!1;let t=this._eventHandlers[e];return t||(t=this._eventHandlers[e]=[]),!(t.indexOf(r)>=0||(r._once=!1,t.push(r),0))}once(e,r){if(!e||!r)return!1;if(!this.isValidType(e))return!1;if(!this.isValidHandler(r))return!1;const t=this.on(e,r);return t&&(r._once=!0),t}off(e,r){if(!e)return this.offAll();if(!r)return void(this._eventHandlers[e]=[]);if(!this.isValidType(e))return;if(!this.isValidHandler(r))return;const t=this._eventHandlers[e];if(t&&t.length)for(let e=0;e<t.length;e++)if(t[e]===r){t.splice(e,1);break}}offAll(){this._eventHandlers={}}emit(e,r){if(!e||!this.isValidType(e))return;const t=this._eventHandlers[e];if(!t||!t.length)return;const n=this.createEvent(e,r);for(let r of t)this.isValidHandler(r)&&(r._once&&(n.once=!0),r(n),n.once&&this.off(e,r))}has(e,r){if(!e||!this.isValidType(e))return!1;const t=this._eventHandlers[e];return!(!t||!t.length||r&&this.isValidHandler(r)&&!(t.indexOf(r)>=0))}getHandlers(e){return e&&this.isValidType(e)&&this._eventHandlers[e]||[]}createEvent(e,r,t=!1){return{type:e,data:r,timestamp:Date.now(),once:t}}}function t(e,r){return Object.keys(e).forEach(t=>{r(e[t],t)})}class n extends r{constructor(){super()}registerHandlers(e){if("object"==typeof e){var r=this;t(e,function(e,t){r.on(t,e)})}}filterParameters(e,r){var n={};return t(e,function(e,t){var s;["error","success","handlers"].includes(s=t)||(r||[]).includes(s)||(n[t]=e)}),n}scheduleCallback(e,r){return setTimeout(e,r)}cancelCallback(e){clearTimeout(e)}}window.EventEmitter=r,window.LastFmNode=class{constructor(e){e=e||{},this.url="/2.0/",this.host=e.host||"http://ws.audioscrobbler.com",this.format="json",this.secret=e.secret,this.api_key=e.api_key}request(e,r){return new class extends n{constructor(e,r,t){super();var n=["track.scrobble","track.updatenowplaying"],s=["auth.getmobilesession","auth.getsession","auth.gettoken","radio.getplaylist","user.getrecentstations","user.getrecommendedartists","user.getrecommendedevents"],i=this;function o(){return t.signed||a()||(e=r)&&s.includes(e.toLowerCase());var e}function a(){return t.write||(e=r)&&n.includes(e.toLowerCase());var e}t=t||{},i.registerHandlers(t.handlers),function(t,n,s){var c=a()?"POST":"GET",u=function(e){var r=[];for(var t in e)e.hasOwnProperty(t)&&r.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return r.join("&")}(function(t){var n=i.filterParameters(t,["signed","write"]);return n.method=r,n.api_key=n.api_key||e.api_key,n.format=n.format||e.format,o()&&(n.api_sig=function(e,r){var t="";return Object.keys(e).sort().forEach(function(r){if("format"!=r){var n=void 0!==e[r]&&null!==e[r]?e[r]:"";t+=r+n}}),t+=r,md5(t)}(n,e.secret)),n}(s));"GET"==c&&(n+="?"+u);var l={method:c,headers:function(e,r,t){var n={};return"POST"==c&&(n["Content-Length"]=t.length,n["Content-Type"]="application/x-www-form-urlencoded"),n}(0,0,u),body:"POST"==c?u:null};fetch(t+n,l).then(e=>e.json()).then(e=>i.emit("success",e)).catch(e=>i.emit("error",e))}(e.host,e.url,t)}}(this,e,r)}update(e,r,t){return new class extends n{constructor(e,r,t,n){super();var s=[11,16,29],i=[1e4,3e4,6e4,3e5,9e5,18e5],o=this;(function(e){o.registerHandlers(e.handlers)})(n=n||{}),t.isAuthorised()?"scrobble"!==r&&"nowplaying"!==r||function(r,n){if("scrobble"!=r||n.timestamp){var a=0,c=function(e){var r=o.filterParameters(e);return r.sk=t.key,r}(n),u="scrobble"==r?"track.scrobble":"track.updateNowPlaying";l()}else o.emit("error",{error:6,message:"Invalid parameters - Timestamp is required for scrobbling"});function l(){var r=e.request(u,c);r.on("error",f),r.on("success",d)}function d(e){e.data&&o.emit("success",n.track)}function f(e){let t=e.data;if(function(e){return"scrobble"==r&&s.includes(e.error)}(t)){var n=function(e){var r=Math.min(e,i.length-1);return i[r]}(a++),c={error:t.error,message:t.message,delay:n};return o.emit("retrying",c),void o.scheduleCallback(l,n)}!function(e){o.emit("error",e)}(t)}}(r,n):this.emit("error",{error:4,message:"Authentication failed"})}}(this,e,r,t)}session(e,r){return new class extends n{constructor(e,r,t){super();var n=this,s=!0;function i(r,t){(function(e){n.registerHandlers(e.handlers)})(t=t||{}),function r(t,i){if(i=i||{},t){var a={token:t},c=e.request("auth.getSession",a);console.log(a),c.on("success",o),c.on("error",function(e){let o=e.data;if(function(e){return 14==e.error||16==e.error||11==e.error}(o)){if(!s)return;var a=i.retryInterval||1e4;return n.emit("retrying",{error:o.error,message:o.message,delay:a}),void n.scheduleCallback(function(){r(t,i)},a)}!function(e){n.emit("error",e)}(o)})}else n.emit("error",new Error("No token supplied"))}(r,t)}function o(e){let r=e.data;var t;r.session?(t=r.session,n.user=t.name,n.key=t.key,n.emit("authorised",n),n.emit("success",n)):n.emit("error",new Error("Unexpected error"))}"object"!=typeof(r=r||{})?(this.user=r||"",this.key=t||""):(this.user=r.user||"",this.key=r.key||""),r.token&&i(r.token,r),this.authorise=function(e,r){i(e,r)},this.cancel=function(){s=!1}}isAuthorised(){return""!==this.key}}(this,e,r)}}}();